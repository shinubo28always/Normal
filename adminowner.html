<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AniReal - Admin Panel</title>
    <style>
        :root { --primary: #1e90ff; --secondary: #222; --background: #000; --text-primary: #fff; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--background); color: var(--text-primary); padding-bottom: 80px; }
        
        /* Header */
        header { background: #111; padding: 15px 20px; border-bottom: 1px solid #333; position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; }
        header h1 { font-size: 22px; color: var(--primary); }

        /* Container */
        .container { max-width: 800px; margin: 20px auto; padding: 0 15px; }

        /* View Sections */
        .view { display: none; }
        .view.active { display: block; }

        /* List Styles */
        .list-item { background: #1a1a1a; border: 1px solid #333; padding: 15px; margin-bottom: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        .list-info h3 { font-size: 16px; margin-bottom: 5px; }
        .list-info p { font-size: 12px; color: #aaa; }
        .tag-badge { background: var(--primary); color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-right: 5px; }

        /* Buttons */
        .btn-group { display: flex; gap: 10px; }
        button { cursor: pointer; border: none; border-radius: 5px; padding: 8px 12px; font-weight: 600; transition: 0.2s; }
        .btn-edit { background: #444; color: white; }
        .btn-delete { background: #ff4444; color: white; }
        .btn-primary { background: var(--primary); color: white; width: 100%; padding: 12px; font-size: 16px; margin-top: 10px; }

        /* Bottom Nav */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: #111; border-top: 1px solid #333; display: flex; height: 60px; justify-content: space-around; align-items: center; z-index: 500; }
        .nav-btn { background: none; color: #777; font-size: 12px; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .nav-btn.active { color: var(--primary); }
        .nav-btn i { font-size: 20px; }

        /* FAB (Add Button) */
        .fab { position: fixed; bottom: 75px; right: 20px; width: 55px; height: 55px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 30px; box-shadow: 0 4px 10px rgba(30,144,255,0.4); z-index: 501; }

        /* Form Modal */
        #form-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 2000; display: none; overflow-y: auto; padding: 20px; }
        .form-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .close-form { font-size: 30px; background: none; color: white; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; color: #ccc; font-size: 14px; }
        .form-group input, .form-group select { width: 100%; padding: 12px; background: #222; border: 1px solid #444; color: white; border-radius: 5px; outline: none; }
        .form-group input:focus { border-color: var(--primary); }
        .hint { font-size: 11px; color: #888; margin-top: 4px; display: block; }

        /* Add Choice Modal */
        .choice-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1500; display: none; align-items: center; justify-content: center; }
        .choice-content { background: #222; padding: 20px; border-radius: 10px; width: 80%; max-width: 300px; display: flex; flex-direction: column; gap: 15px; }
        
        /* Loader */
        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:none; align-items:center; justify-content:center; z-index:3000; }
        .spinner { border: 4px solid #333; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

    <header>
        <h1>AniReal Admin</h1>
    </header>

    <!-- VIEW: BANNERS -->
    <div id="view-slides" class="view active">
        <div class="container">
            <h2 style="margin-bottom: 15px; border-left: 3px solid var(--primary); padding-left: 10px;">Home Banners</h2>
            <div id="slides-list"></div>
        </div>
    </div>

    <!-- VIEW: ANIMES -->
    <div id="view-animes" class="view">
        <div class="container">
            <h2 style="margin-bottom: 15px; border-left: 3px solid var(--primary); padding-left: 10px;">All Animes</h2>
            <div id="animes-list"></div>
        </div>
    </div>

    <!-- FAB -->
    <button class="fab" onclick="openChoiceModal()">+</button>

    <!-- CHOICE MODAL -->
    <div id="choice-modal" class="choice-modal" onclick="closeChoiceModal(event)">
        <div class="choice-content">
            <h3 style="text-align:center;">What to add?</h3>
            <button class="btn-primary" onclick="openForm('animes')">Add Anime Card</button>
            <button class="btn-primary" style="background:#444;" onclick="openForm('slides')">Add Home Banner</button>
        </div>
    </div>

    <!-- FORM MODAL -->
    <div id="form-modal">
        <div class="form-header">
            <h2 id="form-title">Add Item</h2>
            <button class="close-form" onclick="closeForm()">Ã—</button>
        </div>
        <form id="main-form">
            <input type="hidden" id="docId">
            <input type="hidden" id="collectionName">

            <!-- COMMON FIELDS -->
            <div class="form-group field-common">
                <label>Title</label>
                <input type="text" id="title" required placeholder="Anime Name">
            </div>

            <!-- BANNER FIELDS -->
            <div class="form-group field-slides">
                <label>Banner Image URL (Big)</label>
                <input type="url" id="bannerImage" placeholder="https://...">
            </div>
            <div class="form-group field-slides">
                <label>Card Image URL (Small)</label>
                <input type="url" id="cardImage" placeholder="https://...">
            </div>
            <div class="form-group field-slides">
                <label>Banner Genres</label>
                <input type="text" id="genres" placeholder="Action, Magic, etc">
            </div>
            <div class="form-group field-slides">
                <label>Episode Text</label>
                <input type="text" id="episode" placeholder="Ep: 12">
            </div>

            <!-- ANIME CARD FIELDS -->
            <div class="form-group field-animes">
                <label>Poster Image URL</label>
                <input type="url" id="imageUrl" placeholder="https://...">
            </div>
            
            <div class="form-group field-animes">
                <label>Rating</label>
                <input type="number" step="0.1" id="rating" placeholder="e.g. 9.5">
            </div>

            <!-- MAIN LOGIC FIELDS -->
            <div class="form-group field-animes">
                <label style="color: var(--primary);">Category Tag (Important)</label>
                <select id="tags_select" onchange="toggleFields()">
                    <option value="new">New Release (Uses Genre)</option>
                    <option value="tophit">Top Hit (Uses Episodes)</option>
                    <option value="popular">Most Popular (Uses Episodes)</option>
                    <option value="favourite">Most Favourite (Uses Episodes)</option>
                </select>
                <input type="hidden" id="tags"> <!-- Hidden input to store array -->
            </div>

            <!-- DYNAMIC FIELDS -->
            <div class="form-group field-animes" id="genre-group">
                <label>Genre</label>
                <input type="text" id="genre" placeholder="e.g. Action">
                <span class="hint">Shows only in 'New Releases'</span>
            </div>

            <div class="form-group field-animes" id="episodes-group">
                <label>Episodes</label>
                <input type="text" id="episodes" placeholder="e.g. 24">
                <span class="hint">Shows in Popular, Top Hits, etc.</span>
            </div>

            <button type="submit" class="btn-primary">Save Data</button>
        </form>
    </div>

    <!-- BOTTOM NAV -->
    <div class="bottom-nav">
        <button class="nav-btn active" onclick="switchView('slides')">
            <i class="fas fa-images"></i>
            <span>Banners</span>
        </button>
        <button class="nav-btn" onclick="switchView('animes')">
            <i class="fas fa-play-circle"></i>
            <span>Animes</span>
        </button>
    </div>

    <div id="loader"><div class="spinner"></div></div>

    <!-- FIREBASE SCRIPTS -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyADkvP-TKwlV4JfYfY6rlfyhcRKmfc_Cqw",
            authDomain: "anireal-web-68c69.firebaseapp.com",
            databaseURL: "https://anireal-web-68c69-default-rtdb.firebaseio.com",
            projectId: "anireal-web-68c69",
            storageBucket: "anireal-web-68c69.appspot.com",
            messagingSenderId: "1065490338135",
            appId: "1:1065490338135:web:eaf17782c03343f3a3ae12",
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- DOM ELEMENTS ---
        const formModal = document.getElementById('form-modal');
        const choiceModal = document.getElementById('choice-modal');
        const loader = document.getElementById('loader');
        const mainForm = document.getElementById('main-form');

        // --- NAVIGATION ---
        function switchView(viewName) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById('view-' + viewName).classList.add('active');
            
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            // Simple active toggle logic based on order
            if(viewName === 'slides') document.querySelectorAll('.nav-btn')[0].classList.add('active');
            else document.querySelectorAll('.nav-btn')[1].classList.add('active');
        }

        // --- MODALS ---
        function openChoiceModal() { choiceModal.style.display = 'flex'; }
        function closeChoiceModal(e) { if(e.target === choiceModal) choiceModal.style.display = 'none'; }
        
        function openForm(collection, mode = 'add', id = null) {
            choiceModal.style.display = 'none';
            formModal.style.display = 'block';
            mainForm.reset();
            
            document.getElementById('collectionName').value = collection;
            document.getElementById('docId').value = id || '';
            document.getElementById('form-title').textContent = mode === 'edit' ? 'Edit Item' : 'Add New Item';

            // Hide all first
            document.querySelectorAll('.field-slides, .field-animes').forEach(el => el.style.display = 'none');

            // Show based on collection
            if (collection === 'slides') {
                document.querySelectorAll('.field-slides').forEach(el => el.style.display = 'block');
            } else {
                document.querySelectorAll('.field-animes').forEach(el => el.style.display = 'block');
                toggleFields(); // Run logic to show genre vs episode
            }

            // If Edit, Fetch Data
            if (mode === 'edit' && id) {
                loadDataForEdit(collection, id);
            }
        }

        function closeForm() { formModal.style.display = 'none'; }

        // --- LOGIC FOR GENRE vs EPISODE ---
        function toggleFields() {
            const tag = document.getElementById('tags_select').value;
            const genreGroup = document.getElementById('genre-group');
            const epGroup = document.getElementById('episodes-group');

            if (tag === 'new') {
                genreGroup.style.display = 'block';
                epGroup.style.display = 'none';
            } else {
                genreGroup.style.display = 'none';
                epGroup.style.display = 'block';
            }
        }

        // --- CRUD OPERATIONS ---
        
        // 1. SAVE
        mainForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loader.style.display = 'flex';

            const collection = document.getElementById('collectionName').value;
            const id = document.getElementById('docId').value;
            const data = {};

            // Get Title
            data.title = document.getElementById('title').value;

            if (collection === 'slides') {
                data.bannerImage = document.getElementById('bannerImage').value;
                data.cardImage = document.getElementById('cardImage').value;
                data.genres = document.getElementById('genres').value;
                data.episode = document.getElementById('episode').value;
            } else {
                // Animes Logic
                data.imageUrl = document.getElementById('imageUrl').value;
                data.rating = document.getElementById('rating').value;
                
                // Tag Logic
                const selectedTag = document.getElementById('tags_select').value;
                data.tags = [selectedTag]; // Save as array for query

                if (selectedTag === 'new') {
                    data.genre = document.getElementById('genre').value;
                    data.episode = null; // Reset ep
                } else {
                    data.episode = document.getElementById('episodes').value;
                    data.genre = null; // Reset genre
                }
            }

            data.createdAt = firebase.firestore.FieldValue.serverTimestamp();

            try {
                if (id) {
                    await db.collection(collection).doc(id).update(data);
                } else {
                    await db.collection(collection).add(data);
                }
                closeForm();
                fetchList(collection);
            } catch (error) {
                alert(error.message);
            }
            loader.style.display = 'none';
        });

        // 2. FETCH LIST
        async function fetchList(collectionName) {
            const container = document.getElementById(collectionName + '-list');
            container.innerHTML = '<p style="text-align:center; color:#777;">Loading...</p>';

            try {
                const snapshot = await db.collection(collectionName).orderBy('createdAt', 'desc').get();
                container.innerHTML = '';
                
                if(snapshot.empty) {
                    container.innerHTML = '<p style="text-align:center;">No items found.</p>';
                    return;
                }

                snapshot.forEach(doc => {
                    const item = doc.data();
                    const div = document.createElement('div');
                    div.className = 'list-item';
                    
                    let subtitle = '';
                    if(collectionName === 'slides') subtitle = item.genres;
                    else subtitle = item.tags ? item.tags[0].toUpperCase() : 'NO TAG';

                    div.innerHTML = `
                        <div class="list-info">
                            <h3>${item.title}</h3>
                            <p><span class="tag-badge">${collectionName === 'animes' ? subtitle : 'BANNER'}</span></p>
                        </div>
                        <div class="btn-group">
                            <button class="btn-edit" onclick="openForm('${collectionName}', 'edit', '${doc.id}')"><i class="fas fa-edit"></i></button>
                            <button class="btn-delete" onclick="deleteItem('${collectionName}', '${doc.id}')"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    container.appendChild(div);
                });
            } catch (e) {
                console.log(e);
            }
        }

        // 3. LOAD FOR EDIT
        async function loadDataForEdit(collection, id) {
            loader.style.display = 'flex';
            const doc = await db.collection(collection).doc(id).get();
            const data = doc.data();

            document.getElementById('title').value = data.title;

            if (collection === 'slides') {
                document.getElementById('bannerImage').value = data.bannerImage;
                document.getElementById('cardImage').value = data.cardImage;
                document.getElementById('genres').value = data.genres;
                document.getElementById('episode').value = data.episode;
            } else {
                document.getElementById('imageUrl').value = data.imageUrl;
                document.getElementById('rating').value = data.rating;
                
                // Set Tag Select
                if(data.tags && data.tags.length > 0) {
                    document.getElementById('tags_select').value = data.tags[0];
                }
                toggleFields(); // Update UI based on tag

                if (data.genre) document.getElementById('genre').value = data.genre;
                if (data.episode) document.getElementById('episodes').value = data.episode;
            }
            loader.style.display = 'none';
        }

        // 4. DELETE
        async function deleteItem(collection, id) {
            if(!confirm('Delete this item?')) return;
            loader.style.display = 'flex';
            await db.collection(collection).doc(id).delete();
            fetchList(collection);
            loader.style.display = 'none';
        }

        // INITIAL LOAD
        fetchList('slides');
        fetchList('animes');

    </script>
</body>
</html>
